# 二十四節気・七十二候アプリケーション 設計ドキュメント

## 1. プロジェクト概要

このプロジェクトは、日本の伝統的な暦である「二十四節気」と「七十二候」を表示するウェブアプリケーションです。ユーザーは現在の節気や候を確認でき、プッシュ通知機能により暦の変わり目をリアルタイムで知ることができます。

## 2. システム構成

### 2.1 フロントエンド

- **言語/フレームワーク**: HTML, CSS, JavaScript, PHP
- **主要機能**:
  - 現在の節気・候の表示
  - カレンダー表示
  - プッシュ通知の購読管理
  - PWA (Progressive Web App) 対応

### 2.2 バックエンド

- **言語/フレームワーク**: Node.js (Express)
- **主要機能**:
  - プッシュ通知サーバー
  - 暦情報の取得と管理
  - 購読者管理

### 2.3 データストア

- **データ形式**: CSV, テキストファイル
- **主要データ**:
  - `24sekki.csv`: 二十四節気のデータ
  - `72kou.csv`: 七十二候のデータ
  - `subscriptions.txt`: プッシュ通知の購読情報

## 3. コンポーネント詳細

### 3.1 フロントエンド (PHP)

#### 3.1.1 メインページ (`index.php`)
- 現在の節気または候を表示
- 前後の節気・候へのナビゲーション
- 背景画像表示
- 解説文表示
- 「季節のことば」コラム表示（Google Spreadsheetから取得）

#### 3.1.2 カレンダーページ (`calendar.php`)
- 年間の節気・候カレンダー表示
- 月別表示

#### 3.1.3 購読管理 (`subscribe.php`)
- プッシュ通知の購読処理

#### 3.1.4 共通機能 (`functions.php`)
- 節気・候データの読み込み
- 日付計算
- ユーティリティ関数

#### 3.1.5 スプレッドシートデータ取得 (`get_spreadsheet_data.php`)
- Google Spreadsheetからコラムデータを取得

#### 3.1.6 PWA対応
- `service-worker.js`: オフライン対応
- `manifest.json`: PWAマニフェスト

### 3.2 バックエンド (Node.js)

#### 3.2.1 プッシュ通知サーバー (`push-server/index.js`)
- **エンドポイント**:
  - `/`: サーバー状態確認
  - `/test`: サーバー動作テスト
  - `/send`: 通知送信（GET/POST）
  - `/check-subscriptions`: 購読情報確認
  - `/test-notification-now`: 即時テスト通知
  - `/test-next-sekki`: 次の節気への変更テスト
  - `/check-sekki-change`: 暦変更チェック

- **主要機能**:
  - `getCurrentSekki()`: 現在の節気情報取得
  - `sendNotificationToAll()`: 全購読者へ通知送信
  - 定期実行（cron）: 毎日0時に暦変更チェック

## 4. データフロー

1. **暦情報取得**:
   - ユーザーがサイトにアクセス
   - PHP側で現在日付に対応する節気・候を計算
   - 対応する情報と画像を表示

2. **プッシュ通知フロー**:
   - ユーザーが通知を購読
   - 購読情報が`subscriptions.txt`に保存
   - Node.jsサーバーが定期的に暦の変更をチェック
   - 変更があれば全購読者に通知を送信

## 5. 設定情報

### 5.1 環境変数 (`.env`)
- `PORT`: サーバーポート
- `VAPID_PUBLIC_KEY`: Web Push用公開鍵
- `VAPID_PRIVATE_KEY`: Web Push用秘密鍵
- `SUBSCRIPTIONS_URL`: 購読情報のURL

## 6. デプロイメント

### 6.1 フロントエンド
- PHPが動作するWebサーバー（さくらサーバーなど）にデプロイ

### 6.2 バックエンド
- Node.jsが動作するサーバーにデプロイ
- 環境変数の設定
- PM2などでプロセス管理

## 7. 今後の拡張可能性

- 複数言語対応
- ユーザーアカウント機能
- カスタム通知設定
- 暦に関連する行事情報の追加
- 季節の食材や風物詩の情報追加

## 8. 技術的な注意点

- プッシュ通知はHTTPS環境でのみ動作
- サービスワーカーのスコープに注意
- 購読情報の安全な管理
- クロスオリジン問題への対応（CORS設定）
